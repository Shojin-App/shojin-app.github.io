---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { marked } from "marked";

// GitHubã‹ã‚‰CHANGELOGãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
const CHANGELOG_URL =
  "https://github.com/Shojin-App/shojin_app/raw/refs/heads/main/CHANGELOG.md";
let changelogContent = "";
let errorMessage = "";

try {
  const response = await fetch(CHANGELOG_URL);
  if (response.ok) {
    const changelogText = await response.text();
    // Markdownã‚’HTMLã«å¤‰æ›
    changelogContent = await marked(changelogText);
  } else {
    errorMessage = "CHANGELOGã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
  }
} catch (error) {
  errorMessage = "CHANGELOGã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
}

const htmlContent = errorMessage
  ? `<div class="error-message"><p>${errorMessage}</p></div>`
  : `<div class="changelog-content">${changelogContent}</div>`;
---

<Layout
  title="Changelogs | Shojin-App"
  description="Shojin Appã®å¤‰æ›´å±¥æ­´ãƒ»ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ"
>
  <Header />
  <main>
    <div class="container">
      <div class="changelog-header">
        <h1>Changelogs</h1>
        <br>
          Shojin
          Appã®ã™ã¹ã¦ã®å®‰å®šç‰ˆãƒªãƒªãƒ¼ã‚¹ã«ãŠã‘ã‚‹å¤‰æ›´å±¥æ­´ã§ã™ã€‚<br>ã“ã‚Œã‚‰ã®ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã¯
          <a
            href="https://github.com/Shojin-App/shojin_app/releases"
            target="_blank">GitHub</a> ã§ã‚‚ç¢ºèªã§ãã¾ã™
        </p>
        <div class="divider"></div>
      </div>

      <article class="markdown-body" set:html={htmlContent} />
    </div>
  </main>
  <Footer />
</Layout>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const article = document.querySelector(".markdown-body");
    if (!article) return;

    // ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¦‹å‡ºã— (h1) ã®å‡¦ç†
    const h1s = article.querySelectorAll("h1");
    h1s.forEach((h1, index) => {
      // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
      const wrapper = document.createElement("div");
      wrapper.className = "version-header";

      // å…ƒã®h1ã‚’ãƒ©ãƒƒãƒ—ã™ã‚‹å‰ã«ã€h1ã®å†…å®¹ã‚’ç§»å‹•
      h1.parentNode?.insertBefore(wrapper, h1);
      wrapper.appendChild(h1);

      // æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã« "Latest" ãƒãƒƒã‚¸ã‚’è¿½åŠ 
      if (index === 0) {
        const badge = document.createElement("span");
        badge.className = "badge latest";
        badge.textContent = "Latest";
        wrapper.appendChild(badge);
      }

      // æ—¥ä»˜ãŒã‚ã‚Œã°æŠ½å‡ºã—ã¦è¡¨ç¤ºï¼ˆMarkdownã®å½¢å¼ã«ã‚ˆã‚‹ãŒã€ã“ã“ã§ã¯ä»®ã«æ¬¡ã®pã‚¿ã‚°ãŒæ—¥ä»˜ã ã¨ä»®å®šã€ã¾ãŸã¯h1å†…ã«æ—¥ä»˜ãŒå«ã¾ã‚Œã‚‹å ´åˆã‚’è€ƒæ…®ï¼‰
      // ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…ã¨ã—ã¦ã€h1ã®ä¸‹ã«æ—¥ä»˜ç”¨ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¿½åŠ ã—ãªã„ï¼ˆMarkdownã®å†…å®¹ä¾å­˜ã®ãŸã‚ï¼‰
    });

    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦‹å‡ºã— (h2) ã«ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
    const h2s = article.querySelectorAll("h2");
    h2s.forEach((h2) => {
      const text = h2.textContent?.toLowerCase() || "";
      let icon = "";

      if (text.includes("improvement") || text.includes("feature")) {
        icon = "ğŸš€";
      } else if (text.includes("fix")) {
        icon = "ğŸ§©"; // ã¾ãŸã¯ ğŸ›
      } else if (text.includes("change")) {
        icon = "ğŸ“";
      }

      if (icon) {
        h2.innerHTML = `<span class="section-icon">${icon}</span> ${h2.innerHTML}`;
      }
    });

    // Blockquoteã‚’Tipã‚¹ã‚¿ã‚¤ãƒ«ã«
    const blockquotes = article.querySelectorAll("blockquote");
    blockquotes.forEach((bq) => {
      const content = bq.innerHTML;
      bq.innerHTML = `<div class="tip-title">TIP</div><div class="tip-content">${content}</div>`;
    });
  });
</script>

<style is:global>
  /* ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚¿ã‚¤ãƒ«ã¨ã—ã¦é©ç”¨ã—ã¦Markdownå†…ã®è¦ç´ ã«ã‚‚åŠ¹ã‹ã›ã‚‹ */
  .container {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
  }

  .changelog-header {
    margin-bottom: 3rem;
  }

  .changelog-header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    color: var(--on-background);
  }

  .changelog-header p {
    font-size: 1.1rem;
    color: var(--on-surface-variant);
    line-height: 1.6;
  }

  .changelog-header a {
    color: #8ab4f8; /* ãƒªãƒ³ã‚¯è‰²ï¼ˆé’ç³»ï¼‰ */
    text-decoration: none;
  }

  .changelog-header a:hover {
    text-decoration: underline;
  }

  .divider {
    height: 1px;
    background-color: var(--outline-variant);
    margin-top: 2rem;
    opacity: 0.3;
  }

  /* Markdown Content Styles */
  .markdown-body {
    color: var(--on-background);
    line-height: 1.7;
  }

  /* Version Header */
  .version-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-top: 4rem;
    margin-bottom: 1rem;
  }

  .markdown-body h1 {
    font-size: 2rem;
    font-weight: 600;
    margin: 0;
    border: none; /* ä»¥å‰ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ */
    padding: 0;
  }

  .badge.latest {
    background-color: var(--primary-container);
    color: var(--on-primary-container);
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Sections */
  .markdown-body h2 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--on-background);
  }

  .section-icon {
    font-size: 1.4rem;
  }

  .markdown-body ul {
    list-style: none;
    padding: 0;
    margin-bottom: 1.5rem;
  }

  .markdown-body li {
    position: relative;
    padding-left: 1.5rem;
    margin-bottom: 0.75rem;
    color: var(--on-surface-variant);
  }

  .markdown-body li::before {
    content: "â€¢";
    position: absolute;
    left: 0.25rem;
    color: var(--on-surface-variant);
    font-weight: bold;
  }

  /* Links in markdown */
  .markdown-body a {
    color: #8ab4f8;
    text-decoration: none;
  }

  .markdown-body a:hover {
    text-decoration: underline;
  }

  /* Tip Box (Blockquote) */
  .markdown-body blockquote {
    background-color: rgba(138, 180, 248, 0.1); /* è–„ã„é’èƒŒæ™¯ */
    border: 1px solid rgba(138, 180, 248, 0.3);
    border-radius: 8px;
    padding: 1rem 1.5rem;
    margin: 2rem 0;
    color: var(--on-surface);
  }

  .tip-title {
    font-weight: 700;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
    color: #8ab4f8; /* ã‚¿ã‚¤ãƒˆãƒ«è‰² */
    text-transform: uppercase;
  }

  .tip-content p {
    margin: 0;
    font-size: 0.95rem;
  }

  /* Code blocks */
  .markdown-body code {
    background-color: rgba(255, 255, 255, 0.1);
    padding: 0.2em 0.4em;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.9em;
  }

  .error-message {
    color: var(--error);
    text-align: center;
    padding: 2rem;
  }
</style>
